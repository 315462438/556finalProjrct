<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Forum</title>
  <link rel="stylesheet" href="https://fonts.googleapis.com/icon?family=Material+Icons" />
  <style>
    html, body {
      margin: 0;
      padding: 0;
      font-family: Roboto, Inter, sans-serif;
      background: white;
    }
    .container {
      max-width: 1200px;
      padding: 32px 24px;
      margin: 0 auto;
    }
    .row {
      display: flex;
      align-items: center;
      flex-wrap: wrap;
    }
    .row + .row {
      margin-top: 20px;
    }
    .btn {
      border: 1px solid #ccc;
      background: white;
      padding: 8px 16px;
      font-size: 14px;
      cursor: pointer;
    }
    .btn:disabled {
      color: gray;
      cursor: default;
      border-color: #eee;
    }
    .divider {
      border-top: 1px solid #333;
      margin: 20px 0;
    }
    .content {
      display: flex;
      align-items: flex-start;
      gap: 24px;
      flex-wrap: wrap;
      margin-bottom: 40px;
    }
    .avatar-block {
      text-align: center;
      width: 90px;
      flex-shrink: 0;
    }
    .avatar-icon {
      font-size: 48px;
      border: 1px solid #999;
      border-radius: 50%;
      padding: 10px;
      color: #4F378A;
    }
    .main-card {
      border: 1px solid black;
      flex: 1;
      min-width: 300px;
      padding: 24px;
      position: relative;
    }
    .post-header {
      font-size: 24px;
      font-weight: 500;
      margin-bottom: 12px;
    }
    .post-content {
      font-size: 16px;
      margin-bottom: 16px;
      white-space: pre-wrap;
    }
    .image-block {
      border: 1px solid black;
      display: flex;
      justify-content: center;
      align-items: center;
      margin-bottom: 24px;
      padding: 8px;
    }
    .image-block img {
      max-width: 100%;
      height: auto;
      border-radius: 4px;
    }
    .icon-bar {
      display: flex;
      gap: 24px;
      align-items: center;
    }
    .icon-label {
      display: flex;
      align-items: center;
      gap: 6px;
      font-size: 18px;
      cursor: pointer;
    }
    .material-icons.md-36 {
      font-size: 36px;
    }
    .comment-section input {
      font-size: 14px;
    }
  </style>
</head>
<body>
  <div class="container">
    <!-- HOME -->
    <div class="row">
      <button class="btn" onclick="window.location.href='main.html'">HOME</button>
    </div>

    <!-- 版块标题 + Follow -->
    <div class="row" style="gap: 32px;">
      <div id="forum-title" style="font-size:16px;"></div>
      <button class="btn" id="follow-btn">Follow</button>
    </div>

    <div class="divider"></div>

    <!-- 发帖 -->
    <div class="row" style="justify-content: flex-end; margin-bottom: 20px;">
      <button class="btn" id="create-post-btn">Create a Post</button>
    </div>

    <!-- 帖子列表 -->
    <div class="post-list" id="post-list"></div>
  </div>

  <script>
    const params = new URLSearchParams(window.location.search);
    const forum = params.get('forum') || 'Unnamed Forum';
    document.getElementById('forum-title').innerText = forum;

    document.getElementById('create-post-btn').onclick = () => {
      window.location.href = `createPost.html?forum=${encodeURIComponent(forum)}`;
    };

    const followBtn = document.getElementById('follow-btn');
    const sessionUser = localStorage.getItem('session');
    const accounts = JSON.parse(localStorage.getItem('accounts') || '[]');
    const user = accounts.find(u => u.username === sessionUser);

    function updateFollowButton() {
      if (!sessionUser || !user) {
        followBtn.textContent = 'Follow';
        followBtn.disabled = true;
        return;
      }

      user.followedForums = user.followedForums || [];
      const isFollowed = user.followedForums.includes(forum);
      followBtn.textContent = isFollowed ? 'Followed' : 'Follow';
      followBtn.disabled = isFollowed;
    }

    followBtn.onclick = () => {
      if (!sessionUser || !user) {
        alert('Please log in to follow forums.');
        return;
      }
      user.followedForums = user.followedForums || [];
      if (!user.followedForums.includes(forum)) {
        user.followedForums.push(forum);
        localStorage.setItem('accounts', JSON.stringify(accounts));
        followBtn.textContent = 'Followed';
        followBtn.disabled = true;
      }
    };

    updateFollowButton();

    const allPosts = JSON.parse(localStorage.getItem('posts') || '[]');
    let posts = allPosts.filter(p => p.forum === forum);

    if (posts.length === 0 && (forum === 'Fitness' || forum === 'Computer Science')) {
      const defaultPost = {
        forum,
        title: forum,
        content: forum === 'Fitness'
          ? 'what is your go–to pre/post workout meal? Share your healthy...'
          : 'CS Elective Recommendations! Not sure what to take?',
        author: 'Kate',
        likes: 0,
        liked: false,
        comments: []
      };
      posts.push(defaultPost);
    }

    function savePosts() {
      localStorage.setItem('posts', JSON.stringify(allPosts));
    }

    function renderPosts() {
      const postList = document.getElementById('post-list');
      if (posts.length === 0) {
        postList.innerHTML = '<p>No posts yet.</p>';
        return;
      }
      postList.innerHTML = '';
      posts.forEach((post, index) => {
        post.likes = post.likes || 0;
        post.liked = post.liked || false;
        post.comments = post.comments || [];

        const wrapper = document.createElement('div');
        wrapper.className = 'content';
        wrapper.innerHTML = `
          <div class="avatar-block">
            <span class="material-icons avatar-icon">person</span>
            <div id="author-${index}" style="margin-top: 8px; font-size: 14px; cursor: pointer; color: #4F378A;" onclick="window.location.href='profile(1).html?user=${encodeURIComponent(post.author)}'">
              ${post.author || 'User' + (index + 1)}
            </div>
          </div>
          <div class="main-card">
            <div class="post-header">${post.title}</div>
            <div class="post-content">${post.content || ''}</div>
            <div class="image-block">
              ${
                post.image
                  ? `<img src="${post.image}" alt="Post Image" />`
                  : `<span class="material-icons md-36">image</span>`
              }
            </div>
            <div class="icon-bar">
              <div class="icon-label like-btn" data-index="${index}">
                <span class="material-icons">${post.liked ? 'favorite' : 'favorite_border'}</span> ${post.likes}
              </div>
              <div class="icon-label comment-toggle" data-index="${index}">
                <span class="material-icons">chat_bubble_outline</span> ${post.comments.length}
              </div>
            </div>
            <div class="comment-section" style="display:none; margin-top:16px;">
              <div class="comment-list" style="margin-bottom:12px;">
                ${post.comments.map((c,ci) => `
                  <div style="display:flex; justify-content:space-between; margin-bottom:4px;">
                    <span>${c}</span>
                    <button class="btn delete-comment" data-pindex="${index}" data-cindex="${ci}">Delete</button>
                  </div>`).join('')}
              </div>
              <input type="text" class="comment-input" data-index="${index}" placeholder="Add a comment..." style="width:100%; padding:6px;" />
            </div>
          </div>
        `;
        postList.prepend(wrapper);
      });
      attachEventListeners();
    }

    function attachEventListeners() {
      document.querySelectorAll('.like-btn').forEach(btn => {
        btn.onclick = () => {
          const i = +btn.dataset.index;
          posts[i].liked = !posts[i].liked;
          posts[i].likes += posts[i].liked ? 1 : -1;
          savePosts();
          renderPosts();
        };
      });
      document.querySelectorAll('.comment-toggle').forEach(btn => {
        btn.onclick = () => {
          const card = btn.closest('.main-card');
          const sec = card.querySelector('.comment-section');
          sec.style.display = sec.style.display === 'none' ? 'block' : 'none';
        };
      });
      document.querySelectorAll('.comment-input').forEach(input => {
        input.onkeypress = e => {
          if (e.key === 'Enter' && input.value.trim()) {
            const i = +input.dataset.index;
            posts[i].comments.push(input.value.trim());
            input.value = '';
            savePosts();
            renderPosts();
          }
        };
      });
      document.querySelectorAll('.delete-comment').forEach(btn => {
        btn.onclick = () => {
          const pi = +btn.dataset.pindex;
          const ci = +btn.dataset.cindex;
          posts[pi].comments.splice(ci, 1);
          savePosts();
          renderPosts();
        };
      });
    }

    document.addEventListener('DOMContentLoaded', renderPosts);
  </script>
</body>
</html>
